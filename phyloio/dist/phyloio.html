<!DOCTYPE html>
<html lang="en">
<head>
    <title>Phylo.io</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="phyloio.css">

    <!-- JavaScript Bundle with Popper -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script src="bundle.js"></script>

</head>


<style>
    .nav-pills .nav-link {
        border-radius: 0 !important;
    }

    #distance_window {
        border-radius: 8px;
        position: absolute;
        top: 30%;
        left:50%;
        z-index: 9;
        background-color: rgba(235,235,235,0.95);
        text-align: center;

    }

    #mydivheader {
        padding: 10px;
        cursor: move;
        z-index: 1;
        border: 1px solid #d3d3d3;
        border-radius: 8px;
        background-color: rgba(235,235,235,0.95);
        color: rgb(85,85,85);
    }

    #mydivbody{
        border-radius: 8px;
        padding: 10px;
        cursor: move;
        z-index: 1;
        background-color: rgba(235,235,235,0.95);
        color: rgb(85,85,85);

    }

</style>

<body>

<main>


    <!-- Draggable DIV -->
    <div id="distance_window">
        <!-- Include a header DIV with the same name as the draggable DIV, followed by "header" -->
        <div id="mydivheader">Distance  <button class="btn" id="toggle_distance_window" style="float: right "><i id='icon_distance' class="bi-plus" style="color: white "></i></button> </div>
        <div id="mydivbody" style="display: none"  >

        </div>


    </div>

    <div class="d-flex flex-column flex-shrink-0 " style="width: 4.5rem;background-color: rgb(33, 37, 41);
}">
        <a href="https://zoo.vital-it.ch/viewer/" class="d-block p-3 link-dark text-decoration-none" title="" style="text-align: center">
            <i class="bi-triangle" style="font-size: 24px;color: white  "></i>
            <small style="font-size: xx-small; color: white">PHYLO.IO</small>

        </a>

        <ul class="nav nav-pills nav-flush flex-column mb-auto text-center">
            <li class="nav-item">
                <a href="#" class="nav-link  py-3 border-bottom border-top" id="menu_load"  aria-current="page"  data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Load Session" >
                    <i class="bi-upload" style="font-size: 24px;color: white "></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" id="menu_save" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Save Session">
                    <i class="bi-download" style="font-size: 24px;color: white  "></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" id="menu_share" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Share Session">
                    <i class="bi-share" style="font-size: 24px;color: white  "></i>
                </a>
            </li>
            <li>
                <a href="#" id="menu_compare_mode" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Switch between single & compare mode">
                    <i class="bi-layout-split" style="font-size: 24px;color: white  "></i>
                </a>
            </li>
            <li id="li_distance">
                <a href="#" id="menu_distance" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Distance">
                    <i class="bi-rulers" style="font-size: 24px;color: white  "></i>
                </a>
            </li>
            <li>
                <a href="#" id="menu_screenshot" class="nav-link py-3 border-bottom" title="" id="menu_screenshot" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Export as image">
                    <i class="bi-camera" style="font-size: 24px;color: white  "></i>
                </a>
            </li>

        </ul>


        <div class="dropdown border-top">
            <a href="#" id='menu_help' class="d-flex align-items-center justify-content-center p-3  text-decoration-none " style="color: white" >
                <i class="bi-question-circle" style="font-size: 24px; color:white  "></i>
            </a>

        </div>
    </div>


    <!-- Modals -->
    <div class="modal" id="modal_load" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Load a phylo.io session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <input type="file" class="form-control" id="load_session_input" aria-describedby="inputGroupFileAddon04" aria-label="Upload">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button"  class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="load_session_file" class="btn btn-primary">Load the session</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal_share" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Generate a link to share this session </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <br>
                    <div class="d-grid gap-2 col-8 mx-auto">
                        <button class="btn btn-success" type="button" id="btn_share_link">Generate link</button>
                        <br>
                        <a href='#' class="text-center" id="share_link"> </a>
                        <button style="display: none" onclick="copy_clipboard('share_link', 'href')" class="btn btn-outline-dark " type="button" id="btn_share_copy">Copy Url to clipboard</button>

                    </div>
                    <br>
                </div>
                <div class="modal-footer">
                    <button type="button"  class="btn btn-secondary" data-bs-dismiss="modal">I'm done</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal_distance" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Phylogenetic distance settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="switchRF" checked>

                        <label class="form-check-label" for="switchRF">Compute Robinson-Foulds (RF) distance</label>
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="switchClade" checked>
                        <label class="form-check-label" for="switchClade">Compute Clade distance</label>
                    </div>

                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="switchEuc" checked>
                        <label class="form-check-label" for="switchEuc">Compute Euclidian distance</label>
                    </div>



                </div>
                <div class="modal-footer">
                    <button type="button"  class="btn btn-primary" data-bs-dismiss="modal">I'm done here</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal_screenshot" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Screenshot settings </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <label for="s_format_r"><strong>Format:</strong> </label>

                    <div class="btn-group" role="group" id="s_format_r" aria-label="Basic radio toggle button group">

                        <input type="radio" class="btn-check" name="format_screen" id="btnradiosvg" autocomplete="off" checked>
                        <label class="btn btn-outline-primary" for="btnradiosvg">SVG</label>

                        <input type="radio" class="btn-check" name="format_screen" id="btnradiopng" autocomplete="off">
                        <label class="btn btn-outline-primary" for="btnradiopng">PNG</label>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button"  id="button_export_screenshot" class="btn btn-primary" data-bs-dismiss="modal">Export as Image</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal_help" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Phylo.io help center</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Help section is under construction
                </div>
                <div class="modal-footer">
                    <button type="button"  class="btn btn-primary" data-bs-dismiss="modal">I'm done!</button>
                </div>
            </div>
        </div>
    </div>

</main>


<script>

   var copy_clipboard = function(div_id, type){

       var copyText = document.getElementById(div_id);

       if (type == 'href'){
           navigator.clipboard.writeText(copyText.href);
       }
       else {
           navigator.clipboard.writeText(copyText.innerText);
       }

   }

</script>


<script>


    var display_distance_menu = function(compare){

        if (!compare){
            document.getElementById("li_distance").style.display = 'none'
        }
        else if (document.getElementById("li_distance").style.display === 'none'){
            document.getElementById("li_distance").style.display = 'block';
            document.getElementById("menu_distance").onclick = function() {
                $('#modal_distance').modal('show');
            };
        }
    }

    var compare = false;
    const phylo = PhyloIO.init()


    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl)
    })

    if (!compare){
        document.getElementById("li_distance").style.display = 'none'
    }

    // MODALS
    document.getElementById("menu_load").onclick = function() {
        $('#modal_load').modal('show');
    };

    document.getElementById("menu_share").onclick = function() {
        $('#modal_share').modal('show');
    };

    document.getElementById("menu_distance").onclick = function() {
        $('#modal_distance').modal('show');
    };

    document.getElementById("menu_screenshot").onclick = function() {
        $('#modal_screenshot').modal('show');
    };

    document.getElementById("menu_help").onclick = function() {
        $('#modal_help').modal('show');
    };

    // CLICK BINDING
    document.getElementById("menu_compare_mode").onclick = function() {
        compare = !compare
        start_phylo(compare)
        display_distance_menu(compare)
        phylo.display_distance_window()
    };

    document.getElementById("menu_save").onclick = function() {
        phylo.save_session()
    };

    document.getElementById('load_session_file').onclick = () => {
        var file = document.getElementById('load_session_input').files[0];

        $('#modalload').modal('hide');

        if (file) {
            var reader = new FileReader();
            reader.readAsText(file, "UTF-8");
            reader.onload =  (evt) => {

                var pickle = JSON.parse(evt.target.result)

                for(var key in pickle.settings) {
                    var value = pickle.settings[key];
                    phylo.settings[key] = value;
                }

                start_phylo(phylo.settings.compareMode)


                let cs = Object.values(pickle.containers)
                let csp = Object.values(phylo.containers)

                for (var i = 0; i < cs.length; i++) {

                    var ms = cs[i].models


                    for (var j = 0; j < ms.length; j++) {
                        csp[i].add_tree(ms[j].data, ms[j].settings, false)
                        csp[i].models[csp[i].models.length-1].add_circularity_back()
                    }

                    container_object = csp[i]

                    container_object.viewer.set_data(container_object.models[container_object.current_model]);
                    container_object.viewer.render(container_object.viewer.hierarchy);
                    container_object.viewer.update_collapse_level(container_object.models[container_object.current_model].settings.collapse_level)


                }

                phylo.start(recompute=true)

                display_distance_menu(phylo.settings.compareMode)


            }
            reader.onerror = function (evt) {
                console.log("error reading file")
            }
        }

    }

    document.getElementById("button_export_screenshot").onclick = function() {


        if (phylo.settings.compareMode) {

            var svg1 = phylo.bound_container[0].viewer.d3.select("#svg" + phylo.bound_container[0].viewer.uid)
            var svg2 = phylo.bound_container[1].viewer.d3.select("#svg" + phylo.bound_container[1].viewer.uid)
        }

        else {
            var svg1 = Object.values(phylo.containers)[0].viewer.d3.select("#svg" + Object.values(phylo.containers)[0].viewer.uid)
        }

        if (document.getElementById("btnradiosvg").checked){
            phylo.screen_shot({ svg1: svg1,svg2: svg2,format: 'svg'})
        }

        else if (document.getElementById("btnradiopng").checked){
            phylo.screen_shot({ svg1: svg1,svg2: svg2,format: 'png'})
        }




    };

    document.getElementById("btn_share_link").onclick = function() {

        phylo.generate_share_link()
        document.getElementById('share_link').style.width = document.getElementById('btn_share_link').offsetWidth + 'px'
        document.getElementById('share_link').style.wordWrap = 'break-word';
        document.getElementById("share_link").innerText = phylo.session_url
        document.getElementById("share_link").href = phylo.session_url
        document.getElementById("btn_share_copy").style.display = 'block'


    };

    // SWITCH BINDING

    $('#switchRF').on('change.bootstrapSwitch', function(e) {
        phylo.settings.compute_RF = e.target.checked
        phylo.display_distance_window()
    });

    $('#switchClade').on('change.bootstrapSwitch', function(e) {
        phylo.settings.compute_Clade = e.target.checked
        phylo.display_distance_window()
    });

    $('#switchEuc').on('change.bootstrapSwitch', function(e) {
        phylo.settings.compute_Euc = e.target.checked
        phylo.display_distance_window()
    });


    var start_phylo = function(compare){

        if (document.getElementById("containerL")) { document.getElementById("containerL").outerHTML = "";}
        if (document.getElementById("containerR")) {document.getElementById("containerR").outerHTML = "";}
        if (document.getElementById("containerS")) {document.getElementById("containerS").outerHTML = "";}

        var left_con_html = "<div class=\"p-2 flex-grow-1\" id=\"containerL\" style=\"height: 100%; width: 100%; background-color: white; border-right: 1px solid lightgrey\" ></div>"
        var right_con_html = "<div class=\"p-2 flex-grow-1\" id=\"containerR\" style=\"height: 100%; width: 100%; background-color: white;\"></div>"
        var single_con_html = "<div class=\"p-2 flex-grow-1\" id=\"containerS\" style=\"height: 100%; width: 100%; background-color: white;\"></div>"


        phylo.reset()
        phylo.settings.compareMode = compare;
        phylo.phylo_embedded = true

        var m = document.getElementsByTagName('main')[0]

        if (compare){

            m.insertAdjacentHTML('beforeend',left_con_html)
            m.insertAdjacentHTML('beforeend',right_con_html)

            const c1 = phylo.create_container("containerL")
            const c2 = phylo.create_container("containerR")

            phylo.bound_container = [c1,c2];
            phylo.start()

        }

        else {

            m.insertAdjacentHTML('beforeend', single_con_html)

            const c1 = phylo.create_container("containerS")
            phylo.settings.compareMode = compare;
            phylo.start()
        }

        phylo.display_distance_window()

        return phylo


    }

    start_phylo(compare)


    const entries = new URLSearchParams(window.location.search).entries();

    for(const entry of entries) {
        if (entry[0] === 'session'){

            var l = function(pickle){

                pickle = JSON.parse(pickle)

                for(var key in pickle.settings) {
                    var value = pickle.settings[key];
                    phylo.settings[key] = value;
                }

                start_phylo(phylo.settings.compareMode)


                let cs = Object.values(pickle.containers)
                let csp = Object.values(phylo.containers)

                for (var i = 0; i < cs.length; i++) {

                    var ms = cs[i].models


                    for (var j = 0; j < ms.length; j++) {
                        csp[i].add_tree(ms[j].data, ms[j].settings, false)
                        csp[i].models[csp[i].models.length-1].add_circularity_back()
                    }

                    container_object = csp[i]

                    container_object.viewer.set_data(container_object.models[container_object.current_model]);
                    container_object.viewer.render(container_object.viewer.hierarchy);
                    container_object.viewer.update_collapse_level(container_object.models[container_object.current_model].settings.collapse_level)


                }

                phylo.start(recompute=true)

                display_distance_menu(phylo.settings.compareMode)


            }

            phylo.get_share_data(entry[1], function(d){l(d)})


        }

    }

    // Make the DIV element draggable:
    dragElement(document.getElementById("distance_window"));
    document.getElementById("toggle_distance_window").addEventListener('click', event => {

        var d = document.getElementById("mydivbody")

        d.style.display = d.style.display == 'none' ? 'block' : 'none'

        document.getElementById("icon_distance").className = d.style.display == 'none' ? 'bi-plus' : 'bi-dash'



    });

    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        if (document.getElementById(elmnt.id)) {
            // if present, the header is where you move the DIV from:
            document.getElementById(elmnt.id).onmousedown = dragMouseDown;
        } else {
            // otherwise, move the DIV from anywhere inside the DIV:
            elmnt.onmousedown = dragMouseDown;
        }

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // set the element's new position:
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            // stop moving when mouse button is released:
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }







</script>



</body>
</html>