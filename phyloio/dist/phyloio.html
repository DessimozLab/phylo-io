<!DOCTYPE html>
<html lang="en">
<head>
    <title>Phylo.io</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="phyloio.css">

    <!-- JavaScript Bundle with Popper -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
    <script src="bundle.js"></script>

</head>


<style>

    .nav-pills .nav-link {
        border-radius: 0 !important;
    }
</style>

<body>


<main>

    <div class="d-flex flex-column flex-shrink-0 " style="width: 4.5rem;background-color: rgb(33, 37, 41);
}">
        <a href="/" class="d-block p-3 link-dark text-decoration-none" title="" style="text-align: center">
            <i class="bi-circle" style="font-size: 24px;color: white  "></i>

        </a>
        <ul class="nav nav-pills nav-flush flex-column mb-auto text-center">
            <li class="nav-item">
                <a href="#" class="nav-link  py-3 border-bottom" id="menu_load"  aria-current="page"  data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Load Session" >
                    <i class="bi-upload" style="font-size: 24px;color: white "></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" id="menu_save" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Save Session">
                    <i class="bi-download" style="font-size: 24px;color: white  "></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Share Session">
                    <i class="bi-share" style="font-size: 24px;color: white  "></i>
                </a>
            </li>
            <li>
                <a href="#" id="menu_compare_mode" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Switch between single & compare mode">
                    <i class="bi-layout-split" style="font-size: 24px;color: white  "></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Distance">
                    <i class="bi-rulers" style="font-size: 24px;color: white  "></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Export as image">
                    <i class="bi-camera" style="font-size: 24px;color: white  "></i>
                </a>
            </li>
            <li>
                <a href="#" class="nav-link py-3 border-bottom" title="" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-original-title="Configure">
                    <i class="bi-gear" style="font-size: 24px;color: white  "></i>
                </a>
            </li>
        </ul>
        <div class="dropdown border-top">
            <a href="/" class="d-flex align-items-center justify-content-center p-3  text-decoration-none dropdown-toggle" style="color: white" id="dropdownUser3" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-question-circle" style="font-size: 24px; color:white  "></i>
            </a>
            <ul class="dropdown-menu text-small shadow" aria-labelledby="dropdownUser3">
                <li><a class="dropdown-item" href="#">Help</a></li>
                <li><a class="dropdown-item" href="#">About</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#">Contact us</a></li>
            </ul>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal" id="modalload" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Load a phylo.io session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <input type="file" class="form-control" id="load_session_input" aria-describedby="inputGroupFileAddon04" aria-label="Upload">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button"  class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="load_session_file" class="btn btn-primary">Load the session</button>
                </div>
            </div>
        </div>
    </div>










</main>




<script>

    var compare = false;
    const phylo = PhyloIO.init()

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl)
    })

    document.getElementById("menu_compare_mode").onclick = function() {
        compare = compare ? false: true
        start_phylo(compare)
    };
    document.getElementById("menu_save").onclick = function() {
        phylo.save_session()
    };

    document.getElementById("menu_load").onclick = function() {
        $('#modalload').modal('show');
    };

    document.getElementById('load_session_file').onclick = () => {
        var file = document.getElementById('load_session_input').files[0];

        $('#modalload').modal('hide');

        if (file) {
            var reader = new FileReader();
            reader.readAsText(file, "UTF-8");
            reader.onload =  (evt) => {

                var pickle = JSON.parse(evt.target.result)

                for(var key in pickle.settings) {
                    var value = pickle.settings[key];
                    phylo.settings[key] = value;
                }

                start_phylo(phylo.settings.compareMode)


                let cs = Object.values(pickle.containers)
                let csp = Object.values(phylo.containers)

                for (var i = 0; i < cs.length; i++) {

                    var ms = cs[i].models



                    for (var j = 0; j < ms.length; j++) {
                        csp[i].add_tree(ms[j].data, ms[j].settings, false )
                    }

                    container_object = csp[i]

                    container_object.viewer.set_data(container_object.models[container_object.current_model]);
                    container_object.viewer.render(container_object.viewer.hierarchy);
                    container_object.viewer.update_collapse_level(container_object.models[container_object.current_model].settings.collapse_level)


                }

                phylo.start()





            }
            reader.onerror = function (evt) {
                console.log("error reading file")
            }
        }



    }


    var start_phylo = function(compare){

        if (document.getElementById("containerL")) { document.getElementById("containerL").outerHTML = "";}
        if (document.getElementById("containerR")) {document.getElementById("containerR").outerHTML = "";}
        if (document.getElementById("containerS")) {document.getElementById("containerS").outerHTML = "";}

        var left_con_html = "<div class=\"p-2 flex-grow-1\" id=\"containerL\" style=\"height: 100%; width: 100%; background-color: white; border-right: 1px solid lightgrey\" ></div>"
        var right_con_html = "<div class=\"p-2 flex-grow-1\" id=\"containerR\" style=\"height: 100%; width: 100%; background-color: white;\"></div>"
        var single_con_html = "<div class=\"p-2 flex-grow-1\" id=\"containerS\" style=\"height: 100%; width: 100%; background-color: white;\"></div>"


        phylo.reset()
        phylo.settings.compareMode = compare;

        var m = document.getElementsByTagName('main')[0]

        if (compare){

            m.insertAdjacentHTML('beforeend',left_con_html)
            m.insertAdjacentHTML('beforeend',right_con_html)

            const c1 = phylo.create_container("containerL")
            const c2 = phylo.create_container("containerR")

            phylo.bound_container = [c1,c2];
            phylo.start()

        }

        else {


            m.insertAdjacentHTML('beforeend', single_con_html)

            const c1 = phylo.create_container("containerS")
            phylo.settings.compareMode = compare;
            phylo.start()
        }

        return phylo


    }

    start_phylo(compare)


</script>



</body>
</html>